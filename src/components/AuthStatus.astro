---
// AuthStatus Component
// Shows authentication state in header with signin/signout actions

interface Props {
  user: {
    email: string;
    id: string;
  } | null;
}

const { user } = Astro.props;
---

<div id="auth-status" class="flex items-center gap-4">
  {user ? (
    <!-- Authenticated user (SSR) -->
    <>
      <span class="text-sm text-[var(--color-text-secondary)]">{user.email}</span>
      <button
        id="signout-btn"
        class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"
      >
        Sign Out
      </button>
    </>
  ) : (
    <!-- Not authenticated (default for static pages) -->
    <>
      <a
        href="/auth/signin"
        class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"
      >
        Sign In
      </a>
      <a
        href="/auth/signup"
        class="text-sm font-medium text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors"
      >
        Subscribe
      </a>
    </>
  )}
</div>

<script>
  // Check auth status client-side for static pages
  async function checkAuthStatus() {
    try {
      const response = await fetch('/api/auth/session');
      const data = await response.json();

      if (data.user) {
        // User is authenticated, update the UI
        const authStatus = document.getElementById('auth-status');
        if (authStatus) {
          authStatus.innerHTML = `
            <span class="text-sm text-[var(--color-text-secondary)]">${data.user.email}</span>
            <button
              id="signout-btn"
              class="text-sm font-medium text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"
            >
              Sign Out
            </button>
          `;

          // Add signout handler
          document.getElementById('signout-btn')?.addEventListener('click', async () => {
            try {
              await fetch('/api/auth/signout', { method: 'POST' });
              window.location.href = '/';
            } catch (error) {
              console.error('Sign out error:', error);
            }
          });
        }
      }
    } catch (error) {
      // Session check failed, user not authenticated
      console.debug('No active session');
    }
  }

  // Only check on page load if we're on a static page (no server-side user data)
  if (!document.getElementById('signout-btn')) {
    checkAuthStatus();
  } else {
    // SSR page with user, just add signout handler
    document.getElementById('signout-btn')?.addEventListener('click', async () => {
      try {
        await fetch('/api/auth/signout', { method: 'POST' });
        window.location.href = '/';
      } catch (error) {
        console.error('Sign out error:', error);
      }
    });
  }
</script>
